name: Fetch RSS & Deploy

on:
  push:
    branches: [master]
    paths-ignore:
      - 'news.json'
  schedule:
    - cron: '*/30 * * * *'  # 30分ごとに実行
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  fetch-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch RSS and convert to JSON
        run: |
          python3 - <<'PYEOF'
          import urllib.request, xml.etree.ElementTree as ET, json, re, html
          from datetime import datetime, timezone

          headers = {"User-Agent": "Mozilla/5.0"}

          # --- 1. Google News RSS ---
          url = "https://news.google.com/rss/search?q=%E5%80%92%E7%94%A3&hl=ja&gl=JP&ceid=JP:ja"
          req = urllib.request.Request(url, headers=headers)
          data = urllib.request.urlopen(req, timeout=30).read()
          root = ET.fromstring(data)

          items = []
          for item in root.iter("item"):
              raw_title = item.findtext("title", "")
              source_el = item.find("source")
              source = source_el.text if source_el is not None and source_el.text else ""
              if not source:
                  m = re.search(r'[-\u2013\u2014]\s*(.+)$', raw_title)
                  source = m.group(1).strip() if m else ""
              title = re.sub(r'\s*[-\u2013\u2014]\s*[^\-\u2013\u2014]+$', '', raw_title) if source else raw_title
              desc_raw = item.findtext("description", "")
              desc = re.sub(r'<[^>]+>', '', html.unescape(desc_raw)).strip()
              items.append({
                  "title": title,
                  "source": source,
                  "pubDate": item.findtext("pubDate", ""),
                  "link": item.findtext("link", ""),
                  "description": desc,
                  "feed": "google"
              })

          print(f"Google News: {len(items)} articles")

          # --- 2. TSR Data Insight RSS (RDF 1.0) ---
          tsr_items = []
          try:
              tsr_url = "https://www.tsr-net.co.jp/rss/news_analysis.xml"
              tsr_req = urllib.request.Request(tsr_url, headers=headers)
              tsr_data = urllib.request.urlopen(tsr_req, timeout=30).read()
              tsr_root = ET.fromstring(tsr_data)
              ns = {
                  "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
                  "rss": "http://purl.org/rss/1.0/",
                  "dc": "http://purl.org/dc/elements/1.1/"
              }
              for item in tsr_root.findall("rss:item", ns):
                  title = (item.findtext("rss:title", "", ns) or "").strip()
                  link = (item.findtext("rss:link", "", ns) or "").strip()
                  desc_raw = item.findtext("rss:description", "", ns) or ""
                  desc = re.sub(r'<[^>]+>', '', html.unescape(desc_raw)).strip()
                  dc_date = item.findtext("dc:date", "", ns) or ""
                  tsr_items.append({
                      "title": title,
                      "source": "TSRデータインサイト",
                      "pubDate": dc_date,
                      "link": link,
                      "description": desc,
                      "feed": "tsr"
                  })
              print(f"TSR Data Insight: {len(tsr_items)} articles")
          except Exception as e:
              print(f"TSR fetch failed: {e}")

          all_items = tsr_items + items

          with open("news.json", "w", encoding="utf-8") as f:
              json.dump({"items": all_items, "fetched": datetime.now(timezone.utc).isoformat()}, f, ensure_ascii=False)
          print(f"Total saved: {len(all_items)} articles")
          PYEOF

      - name: Commit news.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add news.json
          git diff --cached --quiet && echo "No changes" || git commit -m "Update news.json [skip ci]" && git push

      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: .
      - id: deployment
        uses: actions/deploy-pages@v4
